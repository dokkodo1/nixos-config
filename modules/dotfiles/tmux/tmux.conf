# Basic settings
set-option -g focus-events on
set -g prefix C-a
unbind C-b
bind C-a send-prefix

# Start windows and panes at 1
set -g base-index 1
setw -g pane-base-index 1

# Vi mode
setw -g mode-keys vi

# Live reload tmux config
bind-key o source-file ~/.config/tmux/tmux.conf \; source-file ~/configurations/modules/dotfiles/tmux/tmux.conf \; display-message "tmux.conf reloaded!"

# Create new window
bind-key c new-window -c '#{pane_current_path}'  # Ctrl-a c (new window, same dir)

# Quick window switching
bind-key 1 select-window -t 1    # Ctrl-a 1
bind-key 2 select-window -t 2    # Ctrl-a 2

# Window navigation - standard approach
bind-key -r C-h previous-window    # Ctrl-a Ctrl-h
bind-key -r C-l next-window        # Ctrl-a Ctrl-l
bind-key -r h previous-window      # Ctrl-a h (shortcut)
bind-key -r l next-window          # Ctrl-a l (shortcut)
bind-key Tab last-window          # Ctrl-a Tab (toggle between last two windows)

# Pane navigation - vim-style hjkl
bind-key -r j select-pane -D       # Ctrl-a j (down)
bind-key -r k select-pane -U       # Ctrl-a k (up)  
bind-key -r h select-pane -L       # Ctrl-a h (left) - conflicts with window nav
bind-key -r l select-pane -R       # Ctrl-a l (right) - conflicts with window nav

# Resolve h/l conflict: use different keys for panes when you have multiple panes
bind-key -r C-j select-pane -D     # Ctrl-a Ctrl-j (down pane)
bind-key -r C-k select-pane -U     # Ctrl-a Ctrl-k (up pane)
bind-key -r C-h select-pane -L     # Ctrl-a Ctrl-h (left pane) 
bind-key -r C-l select-pane -R     # Ctrl-a Ctrl-l (right pane)

# Pane resizing - vim-style with Shift
bind-key -r H resize-pane -L 5     # Ctrl-a H (resize left)
bind-key -r J resize-pane -D 5     # Ctrl-a J (resize down)
bind-key -r K resize-pane -U 5     # Ctrl-a K (resize up)
bind-key -r L resize-pane -R 5     # Ctrl-a L (resize right)

# Better pane splitting (more intuitive)
bind-key | split-window -h -c '#{pane_current_path}'  # Ctrl-a | (vertical split)
bind-key - split-window -v -c '#{pane_current_path}'  # Ctrl-a - (horizontal split)
unbind '"'
unbind %

# Quick pane layouts
bind-key Space next-layout         # Ctrl-a Space (cycle layouts)

# Enter copy mode
bind-key [ copy-mode              # Ctrl-a [ (standard)
bind-key Escape copy-mode         # Ctrl-a Escape (alternative)

# Cross-platform copy command (strips newlines)
set -g @copy-command "if command -v pbcopy >/dev/null 2>&1; then tr -d '\n' | pbcopy; elif command -v xclip >/dev/null 2>&1; then tr -d '\n' | xclip -sel clipboard; elif command -v wl-copy >/dev/null 2>&1; then tr -d '\n' | wl-copy; else cat; fi"

# Vi-style copy mode bindings - stay in copy mode after yank
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi V send-keys -X select-line  
bind-key -T copy-mode-vi C-v send-keys -X begin-selection \; send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-pipe "#{@copy-command}"
bind-key -T copy-mode-vi Y send-keys -X copy-end-of-line "#{@copy-command}"
bind-key -T copy-mode-vi q send-keys -X cancel
bind-key -T copy-mode-vi Escape send-keys -X cancel
bind-key -T copy-mode-vi C-c send-keys -X cancel

# Toggle selection off (custom behavior)
bind-key -T copy-mode-vi u send-keys -X clear-selection

# Additional vim-like navigation in copy mode
bind-key -T copy-mode-vi 0 send-keys -X start-of-line
bind-key -T copy-mode-vi $ send-keys -X end-of-line
bind-key -T copy-mode-vi w send-keys -X next-word
bind-key -T copy-mode-vi b send-keys -X previous-word
bind-key -T copy-mode-vi e send-keys -X next-word-end
bind-key -T copy-mode-vi / send-keys -X search-forward
bind-key -T copy-mode-vi ? send-keys -X search-backward
bind-key -T copy-mode-vi n send-keys -X search-again
bind-key -T copy-mode-vi N send-keys -X search-reverse
bind-key -T copy-mode-vi C-d send-keys -X halfpage-down
bind-key -T copy-mode-vi C-u send-keys -X halfpage-up

# Paste - simple buffer system
bind-key ] paste-buffer           # Ctrl-a ] (paste most recent)
bind-key P choose-buffer          # Ctrl-a P (choose from buffer list)
bind-key p paste-buffer           # Ctrl-a p (paste, like vim)

# Mouse support (works on desktop, ignored on TTY)
set -g mouse on

# URL opening with selection menu
bind-key -T copy-mode-vi C-x run-shell 'tmux capture-pane -p | grep -oE "https?://[^[:space:]]+" | sort -u > /tmp/tmux_urls_$$; if [ -s /tmp/tmux_urls_$$ ]; then if [ $(wc -l < /tmp/tmux_urls_$$) -eq 1 ]; then xdg-open "$(cat /tmp/tmux_urls_$$)"; else tmux new-window "cat /tmp/tmux_urls_$$ | nl -w2 -s\": \" && echo && read -p \"Select URL number: \" num && url=\$(sed -n \"\${num}p\" /tmp/tmux_urls_$$) && [ -n \"\$url\" ] && xdg-open \"\$url\"; rm -f /tmp/tmux_urls_$$"; fi; else rm -f /tmp/tmux_urls_$$; fi'

# Scrollback buffer
set -g history-limit 10000

# Clipboard integration
set -g set-clipboard on

# Renumber windows when one is closed
set -g renumber-windows on

# Faster command sequences
set -s escape-time 10

# Increase repeat timeout for -r bindings
set -g repeat-time 200

# Monitor activity
setw -g monitor-activity off
set -g visual-activity on

# Don't auto-rename windows
set-option -g allow-rename on

# Terminal colors
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm*:RGB"
